An op amp with an open loop voltage gain of 80dB and poles at $10^{5}$Hz , $10^{6}$ Hz and $2\times10^{6}$ Hz is said to be compensated to be stable for unity $\beta$. Assume that op amp incorporates an amplifier circuit equivalent to Fig. \ref{fig:ee18btech11029_Eqivalent circuit}  with input parameters in Table 	\ref{fig:ee18btech11029_Eqivalent circuit}

%$C_{1}$=150pF ,$C_{2}$=5pF and $g_{m}$=40mA/V and that 
where $f_{1}$ is caused by input circuit and $f_{2}$ by the output circuit of this amplifier. Find the required value of compensating miller capacitance $C_f$ and the new frequency of the output pole
\begin{figure}[h!]
	\begin{center}
		\resizebox{\columnwidth/1}{!}{\input{./figs/ee18btech11029/ee18btech11029_fig.tex}}
	\end{center}
	\caption{Equivalent amplifier circuit}
	\label{fig:ee18btech11029_Eqivalent circuit}
\end{figure}
\begin{table}[!t]
\centering
\input{./tables/ee18btech11029/ee18btech11029.tex}
\caption{Uncompensated System.}
\label{table:ee18btech11029_ Input_Table}
\end{table}
\section{Without Compensation: $C_f = 0$}
%\begin{enumerate}[label=\arabic*.,ref=\theenumi]
\begin{enumerate}[label=\thesection.\arabic*.,ref=\thesection.\theenumi]
\numberwithin{equation}{enumi}
\item Find the gain of the opamp $G(s)$ and draw the block diagram of the unity feedback system.
\\
\solution The transfer function of the opamp is
\begin{align}
   G(s)&= \frac{10^{4}}{\brak{1+\frac{s}{2\pi\times10^{5}}}\brak{1+\frac{s}{2\pi\times10^{6}}}\brak{1+\frac{s}{2\pi\times2\times10^{6}}}}
\end{align}
The block diagram is available in Fig. 	\ref{fig:ee18btech11029_block}

\begin{figure}[ht!]
	\begin{center}
		\resizebox{\columnwidth}{!}{\input{./figs/ee18btech11029/block.tex}}
	\end{center}
	\caption{}
	\label{fig:ee18btech11029_block}
\end{figure}
%
%The following code plots $G(s)$ in Fig. 	\ref{fig:ee18btech11029_8}
%\begin{lstlisting}
%codes/ee18btech11029/ee18btech11029_2.py
%\end{lstlisting}
%
%\begin{figure}[!h]
%	\centering
%		\includegraphics[width=\columnwidth]{./figs/ee18btech11029/uncompensated.eps}
%	\caption{Bodeplot of Uncompensated system}
%	\label{fig:ee18btech11029_8}
%\end{figure}
\item Design the feedback circuit
\\
\solution See Fig. 	\ref{fig:ee18btech11029_fig1}

\begin{figure}[ht!]
	\begin{center}
		\resizebox{\columnwidth}{!}{\input{./figs/ee18btech11029/ee18btech11029_fig1.tex}}
	\end{center}
	\caption{}
	\label{fig:ee18btech11029_fig1}
\end{figure}

\item Find $\frac{V_o}{I_i}$ in Fig. 	\ref{fig:ee18btech11029_Eqivalent circuit} for $C_f = 0$.
\\
\solution 
%
\begin{align}
    \frac{V_{0}}{I_{i}} = \frac{-g_{m}R_{1}R_{2}}{1+sP+s^{2}Q}
    \label{eq:ee18btech11029_1}
\end{align}
where
\begin{align}
    \label{eq:ee18btech11029_P0}
    P&=C_{1}R_{1}+C_{2}R_{2}\\
    Q&=C_{1}C_{2}R_{1}R_{2}
    \label{eq:ee18btech11029_Q0}
\end{align}
%\begin{align}
%    \label{eq:ee18btech11029_P}
%    P&={C_{1}R_{1}+C_{2}R_{2}+C_{f}\brak{g_{m}R_{1}R_{2}+R_{1}+R_{2}}}\\
%    Q&={\brak{C_{1}C_{2}+C_{f}\brak{C_{1}+C_{2}}}R_{1}R_{2}}
%    \label{eq:ee18btech11029_Q}
%\end{align}
%
\item Let $\omega_1, \omega_2$ be the poles in \eqref{eq:ee18btech11029_1}.  Find $ \omega_1$ and $ \omega_2$.
%
\\
\solution From \eqref{eq:ee18btech11029_1},
\begin{align}
1+sP+s^{2}Q &= \brak{1+\frac{s}{\omega_{1}}}\brak{1+\frac{s}{\omega_{2}}}&
\\
P &= \implies \frac{1}{\omega_{1}} + \frac{1}{\omega_{2}}
\\
Q &= \frac{1}{\omega_1\omega_2} = Q 
%\\
%\text{or, } \frac{1}{\omega_{1}} \approx P  \because \brak{\omega_1 < \omega_2} &
    \label{eq:ee18btech11029_PQ_pole}
\end{align}
yielding 
\begin{align}
\label{eq:ee18btech11029_f}
\begin{split}
    \omega_{1} &= \frac{1}{ R_{1}C_{1}}\\
    \omega_{2}  &= \frac{1}{ R_{2}C_{2}}
\end{split}
\end{align}
%From     \eqref{eq:ee18btech11029_P}, assuming that $g_m \gg 1$, 
%\begin{align}
%    P& \approx C_{f}g_{m}R_{1}R_{2}
%\\
%\implies \omega_{1} &= \frac{1}{P} = \frac{1}{C_{f}g_{m}R_{1}R_{2}}
%    \label{eq:ee18btech11029_p1}
%\end{align}
%From     \eqref{eq:ee18btech11029_PQ_pole}, 
%\begin{align}
%Q &= \omega_1\omega_2
%\\
%\implies  \omega_2 &= \frac{1}{Q\omega_1}
% = \frac{g_{m}C_{f}}{{C_{1}C_{2}+C_{f}\brak{C_{1}+C_{2}}}}
%    \label{eq:ee18btech11029_4}
%\end{align}
%upon substituting from     \eqref{eq:ee18btech11029_Q}
%and     \eqref{eq:ee18btech11029_p1}.

\item Find the values of $R_{1}$ and $R_{2}$\\
\solution From \eqref{eq:ee18btech11029_f}
%
\begin{align}
    R_{1} &= \frac{1}{2\pi C_{1} f_{1}}\\
    R_{2}  &= \frac{1}{2\pi C_{2}f_{2}}
\end{align}
%
which can be computed using the parameters in Table 
\ref{table:ee18btech11029_ Input_Table} and are listed in Table \ref{table:ee18btech11029_R}
%
\begin{table}[!t]
\centering
\input{./tables/ee18btech11029/ee18btech11029_R.tex}
\caption{Resistance values in Fig. 	\ref{fig:ee18btech11029_Eqivalent circuit}
}
\label{table:ee18btech11029_R}
\end{table}
%
\item Investigate  the stability of the closed loop system in Fig. 	\ref{fig:ee18btech11029_block} by finding the step response of Fig. 	\ref{fig:ee18btech11029_fig1}
using spice.
\\
\solution The following netlist simulates the uncompensated system
\begin{lstlisting}
codes/ee18btech11029/spice/ee18btech11029_2.net
\end{lstlisting}

\begin{figure}[!h]
	\centering
		\includegraphics[width=\columnwidth]{./figs/ee18btech11029/spiceuncompensated.eps}
	\caption{Step response of Uncompensated system}
	\label{fig:ee18btech11029_9}
\end{figure}
The following code plots the output of the uncompensated system generated by the above netlist in Fig.\ref{fig:ee18btech11029_9}
\begin{lstlisting}
codes/ee18btech11029/spice/ee18btech11029_2.py
\end{lstlisting}
\end{enumerate}
%
\section{With Compensation: $C_f \ne 0$}
\begin{enumerate}[label=\thesection.\arabic*.,ref=\thesection.\theenumi]
\numberwithin{equation}{enumi}
\item Find $\frac{V_o}{I_i}$ in Fig. 	\ref{fig:ee18btech11029_Eqivalent circuit} for $C_f \ne 0$.
\\
\solution 
%
\begin{align}
    \frac{V_{0}}{I_{i}} = \frac{\brak{sC_{f}-g_{m}}R_{1}R_{2}}{1+sP+s^{2}Q}
    \label{eq:ee18btech11029_nocomp}
\end{align}
where
\begin{align}
    \label{eq:ee18btech11029_Pnocomp}
    P&={C_{1}R_{1}+C_{2}R_{2}+C_{f}\brak{g_{m}R_{1}R_{2}+R_{1}+R_{2}}}\\
    Q&={\brak{C_{1}C_{2}+C_{f}\brak{C_{1}+C_{2}}}R_{1}R_{2}}
    \label{eq:ee18btech11029_Qnocomp}
\end{align}
\item Let $\omega_1, \omega_2$ be the poles in     \eqref{eq:ee18btech11029_nocomp}.  Find $ \omega_1$ and $ \omega_2$.
\\
\solution 
\begin{align}
    \label{eq:ee18btech11029_PQ_pole_nocomp}
1+sP+s^{2}Q = \brak{1+\frac{s}{\omega_{1}}}\brak{1+\frac{s}{\omega_{2}}}&
\\
\implies \frac{1}{\omega_{1}} + \frac{1}{\omega_{2}} = P &
\\
\text{or, } \frac{1}{\omega_{1}} \approx P  \because \brak{\omega_1 < \omega_2} &
\end{align}
From     \eqref{eq:ee18btech11029_Pnocomp}, assuming that $g_m \gg 1$, 
\begin{align}
    P& \approx C_{f}g_{m}R_{1}R_{2}
\\
\implies \omega_{1} &= \frac{1}{P} = \frac{1}{C_{f}g_{m}R_{1}R_{2}}
    \label{eq:ee18btech11029_p1nocomp}
\end{align}
%
From      \eqref{eq:ee18btech11029_PQ_pole_nocomp},

\begin{align}
Q &= \frac{1}{\omega_1\omega_2}
\\
\implies  \omega_2 &= \frac{1}{Q\omega_1}
 = \frac{g_{m}C_{f}}{{C_{1}C_{2}+C_{f}\brak{C_{1}+C_{2}}}}
    \label{eq:ee18btech11029_4nocomp}
\end{align}
upon substituting from     \eqref{eq:ee18btech11029_Qnocomp}
and     \eqref{eq:ee18btech11029_p1nocomp}.

\item For the compensated system, let
\begin{align}
f_1  &= \frac{f_{3}}{G}\\
    &= \frac{2\times10^{6}}{10^{4}} = 200 Hz
\end{align}
%
Find the value of Miller capacitance $C_f$.
\\
\solution From     \eqref{eq:ee18btech11029_p1nocomp},
%\begin{align}
%    \omega_{1} &= \frac{1}{ R_{1}C_{1}}\\
%\end{align}
%    
%\eqref{eq:ee18btech11029_3} we get
\begin{align}
    C_{f}&=\frac{1}{2\pi g_{m}R_{1}R_{2}f_{1}}
\\
\implies         C_{f}&=58.9pF
\end{align}
upon substituting the values from Tables \label{table:ee18btech11029_ Input_Table}
 and \ref{table:ee18btech11029_R}.
\item Find $f_2$.
\\
\solution
From     \eqref{eq:ee18btech11029_4nocomp},
\begin{align}
    f_{2} &= \frac{g_{m}C_{f}}{2\pi\sbrak{C_{1}C_{2} + C_{f}\brak{{C_{1}+C_{2}}}}}
\\
    f_{2}&=37.95MHz
\end{align}
%
All unknown parameters for the compensated system are listed in Table  \ref{table:ee18btech11029_1}

\begin{table}[!t]
\centering
\input{./tables/ee18btech11029/ee18btech11029_1.tex}
\caption{Compensated System}
\label{table:ee18btech11029_1}
\end{table}

\item Find $G(s)$ for the compensated system and sketch the block diagram.\\
\solution The transfer function of the opamp is
\begin{align}
   G(s)&= \frac{10^{4}}{\brak{1+\frac{s}{2\pi\times200}}\brak{1+\frac{s}{2\pi\times37.95\times10^{6}}}\brak{1+\frac{s}{2\pi\times2\times10^{6}}}}
\end{align}
and the block diagram is available in Fig. 	\ref{fig:ee18btech11029_block_comp}

\begin{figure}[ht!]
	\begin{center}
		\resizebox{\columnwidth}{!}{\input{./figs/ee18btech11029/compensatedblock.tex}}
	\end{center}
	\caption{Compensated system}
	\label{fig:ee18btech11029_block_comp}
\end{figure}

\item Through Bode plots, show how $C_f$ affects $G(s)$\\
\solution 
%
\begin{itemize}
    \item $C_f$ downshifts the first pole by factor of $\frac{10^{5}}{200}=500$
    \item $C_f$ upshifts the second pole by factor of $\frac{37.95\times10^{6}}{10^{6}}=37.95$
\end{itemize}
%
This is visible in Fig. 	\ref{fig:ee18btech11029_1} plotted using 
\begin{lstlisting}
codes/ee18btech11029/ee18btech11029_1.py
\end{lstlisting}
%
\begin{figure}[!h]
	\centering
		\includegraphics[width=\columnwidth]{./figs/ee18btech11029/feedback.eps}
	\caption{}
	\label{fig:ee18btech11029_1}
\end{figure}

%\item Design the circuit for uncompensated system\\
%\solution
%\begin{figure}[ht!]
%	\begin{center}
%		\resizebox{\columnwidth}{!}{\input{./figs/ee18btech11029/block.tex}}
%	\end{center}
%	\caption{Uncompensated system}
%	\label{fig:ee18btech11029_block}
%\end{figure}\\
%The transfer function of the opamp is
%\begin{align}
%   G(s)&= \frac{10^{4}}{\brak{1+\frac{s}{2\pi\times10^{5}}}\brak{1+\frac{s}{2\pi\times10^{6}}}\brak{1+\frac{s}{2\pi\times2\times10^{6}}}}
%\end{align}
%\item For feedback gain H\\
%\solution
%The value of the feedback gain is 1,So just place a wire between the input and the output terminal
%\begin{align}
%    H=\frac{V_{f}}{V_{o}}=1
%\end{align}
%\item Verify For Uncompensated system\\
%\solution
%


\item Show that the compensated system is stable by plotting the step response.
\solution
The following netlist simulates the compensated system
\begin{lstlisting}
codes/ee18btech11029/spice/ee18btech11029_3.net
\end{lstlisting}
The following code plots the output of the compensated system generated by the above netlist in Fig.\ref{fig:ee18btech11029_8}
\begin{lstlisting}
codes/ee18btech11029/spice/ee18btech11029_3.py
\end{lstlisting}
Instructions for simulations are given in
\begin{lstlisting}
codes/ee18btech11029/spice/README.md
\end{lstlisting}

%The following code plots Figs. 	\label{fig:ee18btech11029_7}
%and 	\label{fig:ee18btech11029_8}
%
%\begin{lstlisting}
%codes/ee18btech11029/ee18btech11029_3.py
%\end{lstlisting}
%
%\begin{figure}[!h]
%	\centering
%		\includegraphics[width=\columnwidth]{./figs/ee18btech11029/compensated.eps}
%	\caption{Bodeplot for compensated system}
%	\label{fig:ee18btech11029_7}
%\end{figure}
\begin{figure}[!h]
	\centering
		\includegraphics[width=\columnwidth]{./figs/ee18btech11029/spicecompensated.eps}
	\caption{Step response of compensated system}
	\label{fig:ee18btech11029_8}
\end{figure}


\end{enumerate}
